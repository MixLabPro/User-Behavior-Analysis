<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户行为分析 - 综合演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .demo-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .demo-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .demo-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .status-panel {
            background: #2d3748;
            color: #68d391;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .interactive-area {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .interactive-area:hover {
            background: #dee2e6;
            transform: scale(1.02);
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .player-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .aggregator-demo {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .data-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">🎯 用户行为分析 - 综合演示</div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('tracker')">📊 行为追踪</button>
                <button class="nav-tab" onclick="showTab('aggregator')">🔄 数据聚合</button>
                <button class="nav-tab" onclick="showTab('player')">🎬 行为回放</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 行为追踪标签页 -->
        <div id="tracker" class="tab-content active">
            <h2 class="section-title">📊 用户行为追踪演示</h2>
            
            <div class="alert alert-info">
                <strong>功能说明：</strong>这个模块用于实时收集用户在网页上的各种交互行为，包括鼠标移动、点击、键盘输入、滚动等。
            </div>
            
            <div class="demo-grid">
                <div class="demo-card">
                    <h3>🎮 追踪控制</h3>
                    <button class="btn btn-primary" onclick="startTracking()">🚀 开始追踪</button>
                    <button class="btn btn-danger" onclick="stopTracking()">⏹️ 停止追踪</button>
                    <button class="btn btn-secondary" onclick="showTrackingResults()">📋 查看结果</button>
                    <button class="btn btn-secondary" onclick="clearTrackingLog()">🗑️ 清除日志</button>
                </div>
                
                <div class="demo-card">
                    <h3>📈 实时统计</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="clickCount">0</div>
                            <div class="stat-label">点击次数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mouseCount">0</div>
                            <div class="stat-label">鼠标移动</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="scrollCount">0</div>
                            <div class="stat-label">滚动次数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="keyCount">0</div>
                            <div class="stat-label">键盘活动</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="demo-grid">
                <div class="demo-card">
                    <h3>🖱️ 鼠标交互测试</h3>
                    <button class="btn btn-primary" onclick="testClick('按钮A')">点击测试 A</button>
                    <button class="btn btn-success" onclick="testClick('按钮B')">点击测试 B</button>
                    <button class="btn btn-danger" onclick="testClick('按钮C')">点击测试 C</button>
                    <p style="margin-top: 15px;">移动鼠标到这个区域来测试鼠标轨迹追踪。</p>
                </div>
                
                <div class="demo-card">
                    <h3>⌨️ 键盘输入测试</h3>
                    <div class="form-group">
                        <label>文本输入：</label>
                        <input type="text" class="form-control" placeholder="在这里输入文字测试键盘追踪...">
                    </div>
                    <div class="form-group">
                        <label>多行文本：</label>
                        <textarea class="form-control" rows="3" placeholder="输入多行文字..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="demo-card">
                <h3>📝 表单交互测试</h3>
                <form id="testForm" onsubmit="handleFormSubmit(event)">
                    <div class="demo-grid">
                        <div class="form-group">
                            <label>姓名：</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>邮箱：</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>类别：</label>
                            <select class="form-control" name="category">
                                <option value="">请选择</option>
                                <option value="tech">技术</option>
                                <option value="design">设计</option>
                                <option value="marketing">营销</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">提交表单</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="interactive-area" onclick="testInteraction()">
                <h3>🎯 交互测试区域</h3>
                <p>点击这个区域来测试触摸和点击事件</p>
                <p>也可以尝试滚动页面来测试滚动事件</p>
            </div>
            
            <div class="status-panel" id="trackingLog">
                <div>💡 提示：点击"开始追踪"按钮开始收集用户行为数据...</div>
            </div>
        </div>

        <!-- 数据聚合标签页 -->
        <div id="aggregator" class="tab-content">
            <h2 class="section-title">🔄 数据聚合器演示</h2>
            
            <div class="alert alert-info">
                <strong>功能说明：</strong>数据聚合器用于将后端收集的单个事件数据整理成完整的用户行为数据集合，便于分析和处理。
            </div>
            
            <div class="aggregator-demo">
                <h3>📊 模拟后端数据聚合</h3>
                <p>这里演示如何将分散的事件数据聚合成完整的用户行为数据：</p>
                
                <div class="demo-grid">
                    <div class="demo-card">
                        <h4>1️⃣ 模拟事件数据</h4>
                        <button class="btn btn-primary" onclick="generateMockEvents()">生成模拟事件</button>
                        <button class="btn btn-secondary" onclick="clearMockEvents()">清除事件</button>
                        <div class="code-block">
                            <strong>事件数量：</strong><span id="eventCount">0</span>
                        </div>
                    </div>
                    
                    <div class="demo-card">
                        <h4>2️⃣ 数据聚合</h4>
                        <button class="btn btn-success" onclick="aggregateEvents()">聚合数据</button>
                        <button class="btn btn-secondary" onclick="showAggregatedStats()">显示统计</button>
                        <div class="code-block">
                            <strong>聚合状态：</strong><span id="aggregateStatus">未聚合</span>
                        </div>
                    </div>
                </div>
                
                <div class="demo-card">
                    <h4>📋 原始事件数据预览</h4>
                    <div class="data-preview" id="rawEventsPreview">
                        暂无事件数据
                    </div>
                </div>
                
                <div class="demo-card">
                    <h4>📊 聚合后数据预览</h4>
                    <div class="data-preview" id="aggregatedDataPreview">
                        暂无聚合数据
                    </div>
                </div>
                
                <div class="demo-card">
                    <h4>💻 代码示例</h4>
                    <div class="code-block">
<pre>// 导入数据聚合器
import { aggregateUserBehaviorData } from 'user-behavior-analysis/aggregator';

// 聚合事件数据
const events = [/* 从后端获取的事件数据 */];
const sessionId = 'session-123';
const aggregatedData = aggregateUserBehaviorData(events, sessionId);

// 高级处理（包含统计信息）
const processedResult = processUserBehaviorData(events, sessionId, {
    includeStats: true,
    cleanData: true
});</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 行为回放标签页 -->
        <div id="player" class="tab-content">
            <h2 class="section-title">🎬 用户行为回放演示</h2>
            
            <div class="alert alert-info">
                <strong>功能说明：</strong>行为播放器可以将收集到的用户行为数据以动画的形式重新播放，包括鼠标轨迹、点击效果、滚动行为等。
            </div>
            
            <div class="demo-grid">
                <div class="demo-card">
                    <h3>🎮 播放控制</h3>
                    <div class="player-controls">
                        <button class="btn btn-primary" onclick="startRecording()">🔴 开始录制</button>
                        <button class="btn btn-danger" onclick="stopRecording()">⏹️ 停止录制</button>
                        <button class="btn btn-success" onclick="playRecording()">▶️ 播放回放</button>
                        <button class="btn btn-secondary" onclick="pausePlayback()">⏸️ 暂停播放</button>
                        <button class="btn btn-secondary" onclick="stopPlayback()">⏹️ 停止播放</button>
                        <button class="btn btn-secondary" onclick="destroyPlayer()">🗑️ 清除播放器</button>
                    </div>
                </div>
                
                <div class="demo-card">
                    <h3>⚙️ 播放设置</h3>
                    <div class="form-group">
                        <label>播放速度：</label>
                        <select class="form-control" id="playbackSpeed" onchange="updatePlayerConfig()">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showMouseTrail" checked onchange="updatePlayerConfig()">
                            显示鼠标轨迹
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showClickEffect" checked onchange="updatePlayerConfig()">
                            显示点击效果
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoPlay" onchange="updatePlayerConfig()">
                            自动播放
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="demo-card">
                <h3>🎯 录制测试区域</h3>
                <p>在录制期间，在下面的区域进行各种操作来生成测试数据：</p>
                
                <div class="demo-grid">
                    <div class="interactive-area" onclick="recordTestClick('区域A')">
                        <h4>测试区域 A</h4>
                        <p>点击这里</p>
                    </div>
                    <div class="interactive-area" onclick="recordTestClick('区域B')">
                        <h4>测试区域 B</h4>
                        <p>或者点击这里</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>测试输入框：</label>
                    <input type="text" class="form-control" placeholder="在录制时输入文字...">
                </div>
                
                <div class="demo-grid">
                    <button class="btn btn-primary" onclick="recordTestClick('按钮1')">测试按钮 1</button>
                    <button class="btn btn-success" onclick="recordTestClick('按钮2')">测试按钮 2</button>
                    <button class="btn btn-danger" onclick="recordTestClick('按钮3')">测试按钮 3</button>
                </div>
            </div>
            
            <div class="demo-card">
                <h3>📊 录制数据统计</h3>
                <div id="recordingStats" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordedClicks">0</div>
                        <div class="stat-label">录制点击</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recordedMoves">0</div>
                        <div class="stat-label">鼠标移动</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recordedKeys">0</div>
                        <div class="stat-label">键盘活动</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recordingDuration">0s</div>
                        <div class="stat-label">录制时长</div>
                    </div>
                </div>
            </div>
            
            <div class="demo-card">
                <h4>💻 播放器代码示例</h4>
                <div class="code-block">
<pre>// 导入播放器
import userBehaviourPlayer from 'user-behavior-analysis/player';

// 配置播放器
const config = {
    playbackSpeed: 1.5,
    showMouseTrail: true,
    mouseTrailColor: '#ff4444',
    showClickEffect: true,
    autoPlay: true
};

// 加载并播放数据
const trackingData = userBehaviour.showResult();
userBehaviourPlayer.load(trackingData, config);</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入库文件 -->
    <script src="../dist/userBehaviour.js"></script>
    <script src="../dist/aggregateUserBehaviorData.js"></script>
    <script src="../dist/userBehaviourPlayer.js"></script>

    <script>
        // 全局变量
        let isTracking = false;
        let isRecording = false;
        let currentTrackingData = null;
        let currentRecordingData = null;
        let mockEvents = [];
        let aggregatedData = null;
        let currentPlayer = null;
        
        // 标签页切换
        function showTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签按钮的激活状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            
            // 激活对应的标签按钮
            event.target.classList.add('active');
        }
        
        // ==================== 行为追踪功能 ====================
        
        function startTracking() {
            if (!isTracking) {
                userBehaviour.config({
                    userInfo: true,
                    clicks: true,
                    mouseMovement: true,
                    mouseMovementInterval: 0.5,
                    mouseScroll: true,
                    timeCount: true,
                    clearAfterProcess: false,
                    processTime: 2,
                    windowResize: true,
                    visibilitychange: true,
                    keyboardActivity: true,
                    pageNavigation: true,
                    formInteractions: true,
                    touchEvents: true,
                    audioVideoInteraction: true,
                    processData: function(results) {
                        currentTrackingData = results;
                        updateTrackingStats(results);
                        logTrackingActivity('📊 数据处理完成', results);
                    }
                });
                
                userBehaviour.start();
                isTracking = true;
                logTrackingActivity('🚀 开始用户行为追踪');
            } else {
                logTrackingActivity('⚠️ 追踪已经在运行中');
            }
        }
        
        function stopTracking() {
            if (isTracking) {
                userBehaviour.stop();
                isTracking = false;
                logTrackingActivity('⏹️ 停止用户行为追踪');
            } else {
                logTrackingActivity('⚠️ 追踪尚未开始');
            }
        }
        
        function showTrackingResults() {
            const results = userBehaviour.showResult();
            logTrackingActivity('📋 当前追踪结果', results);
            
            // 在新窗口显示详细结果
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head><title>用户行为追踪结果</title></head>
                    <body style="font-family: monospace; padding: 20px;">
                        <h2>📊 用户行为追踪结果</h2>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    </body>
                </html>
            `);
        }
        
        function clearTrackingLog() {
            document.getElementById('trackingLog').innerHTML = '<div>📝 日志已清除</div>';
        }
        
        function updateTrackingStats(results) {
            if (results.clicks) {
                document.getElementById('clickCount').textContent = results.clicks.clickCount;
            }
            if (results.mouseMovements) {
                document.getElementById('mouseCount').textContent = results.mouseMovements.length;
            }
            if (results.mouseScroll) {
                document.getElementById('scrollCount').textContent = results.mouseScroll.length;
            }
            if (results.keyboardActivities) {
                document.getElementById('keyCount').textContent = results.keyboardActivities.length;
            }
        }
        
        function logTrackingActivity(message, data = null) {
            const log = document.getElementById('trackingLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            if (data) {
                logEntry.innerHTML = `[${timestamp}] ${message}`;
            } else {
                logEntry.innerHTML = `[${timestamp}] ${message}`;
            }
            
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        function testClick(buttonName) {
            logTrackingActivity(`🖱️ 点击了 ${buttonName}`);
        }
        
        function handleFormSubmit(event) {
            event.preventDefault();
            logTrackingActivity('📝 表单提交事件被触发');
        }
        
        function testInteraction() {
            logTrackingActivity('🎯 交互测试区域被点击');
        }
        
        // ==================== 数据聚合功能 ====================
        
        function generateMockEvents() {
            mockEvents = [];
            const eventTypes = ['click', 'mouseMovement', 'scroll', 'keyboardActivity', 'windowResize'];
            const baseTime = Date.now();
            
            // 生成50个模拟事件
            for (let i = 0; i < 50; i++) {
                const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                const timestamp = new Date(baseTime + i * 1000).toISOString();
                
                let eventData;
                switch (eventType) {
                    case 'click':
                        eventData = [
                            Math.floor(Math.random() * 800),
                            Math.floor(Math.random() * 600),
                            {
                                tagName: 'BUTTON',
                                id: 'test-btn-' + i,
                                className: 'btn btn-primary',
                                name: '',
                                value: '',
                                textContent: '测试按钮'
                            },
                            timestamp
                        ];
                        break;
                    case 'mouseMovement':
                        eventData = [
                            Math.floor(Math.random() * 800),
                            Math.floor(Math.random() * 600),
                            timestamp
                        ];
                        break;
                    case 'scroll':
                        eventData = [
                            Math.floor(Math.random() * 100),
                            Math.floor(Math.random() * 1000),
                            timestamp
                        ];
                        break;
                    case 'keyboardActivity':
                        const keys = ['a', 'b', 'c', 'Enter', 'Space', 'Backspace'];
                        eventData = [
                            keys[Math.floor(Math.random() * keys.length)],
                            {
                                tagName: 'INPUT',
                                id: 'test-input',
                                className: 'form-control',
                                name: 'test',
                                value: 'test value',
                                textContent: ''
                            },
                            timestamp
                        ];
                        break;
                    case 'windowResize':
                        eventData = [
                            800 + Math.floor(Math.random() * 400),
                            600 + Math.floor(Math.random() * 300),
                            timestamp
                        ];
                        break;
                }
                
                mockEvents.push({
                    type: eventType,
                    data: eventData,
                    timestamp: timestamp,
                    url: window.location.href,
                    userInfo: {
                        windowSize: [window.innerWidth, window.innerHeight],
                        appCodeName: navigator.appCodeName,
                        appName: navigator.appName,
                        vendor: navigator.vendor,
                        platform: navigator.platform,
                        userAgent: navigator.userAgent
                    }
                });
            }
            
            document.getElementById('eventCount').textContent = mockEvents.length;
            document.getElementById('rawEventsPreview').textContent = JSON.stringify(mockEvents.slice(0, 5), null, 2) + '\n...(显示前5个事件)';
        }
        
        function clearMockEvents() {
            mockEvents = [];
            aggregatedData = null;
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('aggregateStatus').textContent = '未聚合';
            document.getElementById('rawEventsPreview').textContent = '暂无事件数据';
            document.getElementById('aggregatedDataPreview').textContent = '暂无聚合数据';
        }
        
        function aggregateEvents() {
            if (mockEvents.length === 0) {
                alert('请先生成模拟事件数据');
                return;
            }
            
            try {
                // 使用聚合器处理数据
                if (typeof aggregateUserBehaviorData !== 'undefined') {
                    aggregatedData = aggregateUserBehaviorData(mockEvents, 'demo-session-' + Date.now());
                    document.getElementById('aggregateStatus').textContent = '已聚合';
                    document.getElementById('aggregatedDataPreview').textContent = JSON.stringify(aggregatedData, null, 2);
                } else {
                    // 如果聚合器未加载，使用简化版本
                    aggregatedData = {
                        userInfo: mockEvents[0].userInfo,
                        time: {
                            startTime: mockEvents[0].timestamp,
                            currentTime: new Date().toISOString(),
                            stopTime: mockEvents[mockEvents.length - 1].timestamp
                        },
                        clicks: {
                            clickCount: mockEvents.filter(e => e.type === 'click').length,
                            clickDetails: mockEvents.filter(e => e.type === 'click').map(e => e.data)
                        },
                        mouseMovements: mockEvents.filter(e => e.type === 'mouseMovement').map(e => e.data),
                        mouseScroll: mockEvents.filter(e => e.type === 'scroll').map(e => e.data),
                        keyboardActivities: mockEvents.filter(e => e.type === 'keyboardActivity').map(e => e.data),
                        navigationHistory: [],
                        formInteractions: [],
                        touchEvents: [],
                        mediaInteractions: [],
                        windowSizes: mockEvents.filter(e => e.type === 'windowResize').map(e => e.data),
                        visibilitychanges: []
                    };
                    document.getElementById('aggregateStatus').textContent = '已聚合（简化版）';
                    document.getElementById('aggregatedDataPreview').textContent = JSON.stringify(aggregatedData, null, 2);
                }
            } catch (error) {
                console.error('聚合数据时出错:', error);
                alert('聚合数据时出错: ' + error.message);
            }
        }
        
        function showAggregatedStats() {
            if (!aggregatedData) {
                alert('请先聚合数据');
                return;
            }
            
            const stats = {
                总事件数: mockEvents.length,
                点击次数: aggregatedData.clicks.clickCount,
                鼠标移动: aggregatedData.mouseMovements.length,
                滚动次数: aggregatedData.mouseScroll.length,
                键盘活动: aggregatedData.keyboardActivities.length,
                窗口调整: aggregatedData.windowSizes.length
            };
            
            alert('聚合数据统计:\n' + JSON.stringify(stats, null, 2));
        }
        
        // ==================== 行为回放功能 ====================
        
        let recordingStartTime = null;
        let recordingTimer = null;
        
        function startRecording() {
            if (!isRecording) {
                // 开始录制
                userBehaviour.config({
                    userInfo: true,
                    clicks: true,
                    mouseMovement: true,
                    mouseMovementInterval: 0.1,
                    mouseScroll: true,
                    timeCount: true,
                    clearAfterProcess: false,
                    processTime: 1,
                    windowResize: true,
                    visibilitychange: true,
                    keyboardActivity: true,
                    pageNavigation: false,
                    formInteractions: true,
                    touchEvents: true,
                    audioVideoInteraction: true,
                    processData: function(results) {
                        currentRecordingData = results;
                        updateRecordingStats(results);
                    }
                });
                
                userBehaviour.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // 更新录制时长
                recordingTimer = setInterval(() => {
                    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                    document.getElementById('recordingDuration').textContent = duration + 's';
                }, 1000);
                
                alert('🔴 开始录制用户行为，请在页面上进行各种操作...');
            } else {
                alert('⚠️ 录制已经在进行中');
            }
        }
        
        function stopRecording() {
            if (isRecording) {
                userBehaviour.stop();
                isRecording = false;
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                currentRecordingData = userBehaviour.showResult();
                alert('⏹️ 录制已停止，可以开始播放回放');
            } else {
                alert('⚠️ 录制尚未开始');
            }
        }
        
        function playRecording() {
            if (!currentRecordingData) {
                alert('请先录制一些用户行为数据');
                return;
            }
            
            try {
                if (typeof userBehaviourPlayer !== 'undefined') {
                    const config = getPlayerConfig();
                    currentPlayer = userBehaviourPlayer;
                    currentPlayer.load(currentRecordingData, config);
                    alert('▶️ 开始播放回放，请观察鼠标轨迹和点击效果');
                } else {
                    alert('播放器未加载，请检查脚本引用');
                }
            } catch (error) {
                console.error('播放回放时出错:', error);
                alert('播放回放时出错: ' + error.message);
            }
        }
        
        function pausePlayback() {
            if (currentPlayer) {
                currentPlayer.pause();
            }
        }
        
        function stopPlayback() {
            if (currentPlayer) {
                currentPlayer.stop();
            }
        }
        
        function destroyPlayer() {
            if (currentPlayer) {
                currentPlayer.destroy();
                currentPlayer = null;
                alert('🗑️ 播放器已清除');
            }
        }
        
        function updatePlayerConfig() {
            // 这个函数在播放器配置改变时调用
            console.log('播放器配置已更新');
        }
        
        function getPlayerConfig() {
            return {
                playbackSpeed: parseFloat(document.getElementById('playbackSpeed').value),
                showMouseTrail: document.getElementById('showMouseTrail').checked,
                mouseTrailColor: '#ff4444',
                mouseTrailWidth: 2,
                showClickEffect: document.getElementById('showClickEffect').checked,
                clickEffectColor: '#00ff00',
                clickEffectSize: 20,
                showScrollIndicator: true,
                showKeyboardInput: true,
                controlPanelPosition: 'bottom',
                autoPlay: document.getElementById('autoPlay').checked,
                loop: false
            };
        }
        
        function updateRecordingStats(results) {
            if (results.clicks) {
                document.getElementById('recordedClicks').textContent = results.clicks.clickCount;
            }
            if (results.mouseMovements) {
                document.getElementById('recordedMoves').textContent = results.mouseMovements.length;
            }
            if (results.keyboardActivities) {
                document.getElementById('recordedKeys').textContent = results.keyboardActivities.length;
            }
        }
        
        function recordTestClick(area) {
            console.log('录制测试点击:', area);
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 用户行为分析综合演示页面已加载');
            console.log('可用的库:', {
                userBehaviour: typeof userBehaviour !== 'undefined',
                aggregateUserBehaviorData: typeof aggregateUserBehaviorData !== 'undefined',
                userBehaviourPlayer: typeof userBehaviourPlayer !== 'undefined'
            });
        });
    </script>
</body>
</html>
